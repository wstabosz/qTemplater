/*! 
 * a-tools 1.4.1
 * 
 * Copyright (c) 2009 Andrey Kramarev(andrey.kramarev[at]ampparit.com), Ampparit Inc. (www.ampparit.com)
 * Licensed under the MIT license.
 * http://www.ampparit.fi/a-tools/license.txt
 *
 * Basic usage:
 
    <textarea></textarea>
    <input type="text" />

    // Get current selection
    var sel = $("textarea").getSelection()
    
    // Replace current selection
    $("input").replaceSelection("foo");

    // Count characters
    alert($("textarea").countCharacters());

    // Set max length without callback function
    $("textarea").setMaxLength(7);

    // Set max length with callback function which will be called when limit is exceeded
    $("textarea").setMaxLength(10, function() {
        alert("hello")
    });

    // Removing limit:
    $("textarea").setMaxLength(-1);
    
    // Insert text at current caret position
    $("#textarea").insertAtCaretPos("hello");
    
    // Set caret position (1 = beginning, -1 = end)
    $("#textArea").setCaretPos(10);
    
    // Set Selection
    $("#textArea").setSelection(10,15);

 */
var caretPositionAmp;jQuery.fn.extend({getSelection:function(){var t=this.jquery?this[0]:this,n,r,a,s=0,v,y,e,i;if(t.onmousedown=function(){document.selection&&typeof t.selectionStart!="number"?document.selection.empty():window.getSelection().removeAllRanges()},document.selection){var u=document.selection.createRange(),c=0,l=0,h=0,f,o;if(t.value.match(/\n/g)!=null&&(s=t.value.match(/\n/g).length),u.text){if(a=u.text,typeof t.selectionStart=="number"){if(n=t.selectionStart,r=t.selectionEnd,n==r)return{start:n,end:r,text:u.text,length:r-n}}else{if(f=t.createTextRange(),o=f.duplicate(),v=f.text,f.moveToBookmark(u.getBookmark()),y=f.text,o.setEndPoint("EndToStart",f),v==y&&v!=u.text)return this;n=o.text.length,r=o.text.length+u.text.length}if(s>0)for(e=0;e<=s;e++)if(i=t.value.indexOf("\n",l),i!=-1&&i<n)l=i+1,c++,h=c;else if(i!=-1&&i>=n&&i<=r){if(i==n+1){c--,h--,l=i+1;continue}l=i+1,h++}else e=s;return u.text.indexOf("\n",0)==1&&(h=h+2),n=n-c,r=r-h,{start:n,end:r,text:u.text,length:r-n}}if(t.focus(),typeof t.selectionStart=="number"?n=t.selectionStart:(u=document.selection.createRange(),f=t.createTextRange(),o=f.duplicate(),f.moveToBookmark(u.getBookmark()),o.setEndPoint("EndToStart",f),n=o.text.length),s>0)for(e=0;e<=s;e++)i=t.value.indexOf("\n",l),i!=-1&&i<n?(l=i+1,c++):e=s;return n=n-c,{start:n,end:n,text:u.text,length:0}}return typeof t.selectionStart=="number"?(n=t.selectionStart,r=t.selectionEnd,a=t.value.substring(t.selectionStart,t.selectionEnd),{start:n,end:r,text:a,length:r-n}):{start:undefined,end:undefined,text:undefined,length:undefined}},replaceSelection:function(n){var t=this.jquery?this[0]:this,u,a,f=0,h,i,s=0,v=0,y=t.scrollTop==undefined?0:t.scrollTop,r,c,l,o,e;if(document.selection&&typeof t.selectionStart!="number"){if(r=document.selection.createRange(),typeof t.selectionStart!="number"&&(i=t.createTextRange(),h=i.duplicate(),c=i.text,i.moveToBookmark(r.getBookmark()),l=i.text,h.setEndPoint("EndToStart",i),c==l&&c!=r.text))return this;if(r.text){if(part=r.text,t.value.match(/\n/g)!=null&&(s=t.value.match(/\n/g).length),u=h.text.length,s>0)for(o=0;o<=s;o++)e=t.value.indexOf("\n",f),e!=-1&&e<u?(f=e+1,v++):o=s;r.text=n,caretPositionAmp=h.text.length+n.length,i.move("character",caretPositionAmp),document.selection.empty(),t.blur()}return this}return typeof t.selectionStart=="number"&&t.selectionStart!=t.selectionEnd?(u=t.selectionStart,a=t.selectionEnd,t.value=t.value.substr(0,u)+n+t.value.substr(a),f=u+n.length,t.setSelectionRange(f,f),t.scrollTop=y,this):this},setSelection:function(n,t){var i,u,r;if(n=parseInt(n),t=parseInt(t),i=this.jquery?this[0]:this,i.focus(),typeof i.selectionStart!="number"&&(re=i.createTextRange(),re.text.length<t&&(t=re.text.length+1)),t<n)return this;if(document.selection){var o=0,f=0,s=0,e=0;if(typeof i.selectionStart!="number")return re.collapse(!0),re.moveEnd("character",t),re.moveStart("character",n),re.select(),this;if(typeof i.selectionStart=="number"){if(i.value.match(/\n/g)!=null&&(o=i.value.match(/\n/g).length),o>0)for(u=0;u<=o;u++)if(r=i.value.indexOf("\n",s),r!=-1&&r<n)s=r+1,f++,e=f;else if(r!=-1&&r>=n&&r<=t){if(r==n+1){f--,e--,s=r+1;continue}s=r+1,e++}else u=o;return n=n+f,t=t+e,i.selectionStart=n,i.selectionEnd=t,this}return this}if(i.selectionStart)return i.focus(),i.selectionStart=n,i.selectionEnd=t,this},insertAtCaretPos:function(n){var t=this.jquery?this[0]:this,u,a,o,r,i,f,h,e=0,l=0,v=t.scrollTop==undefined?0:t.scrollTop,c,s;if(t.focus(),document.selection&&typeof t.selectionStart!="number"&&(t.value.match(/\n/g)!=null&&(l=t.value.match(/\n/g).length),h=parseInt(caretPositionAmp),l>0))for(c=0;c<=l;c++)s=t.value.indexOf("\n",o),s!=-1&&s<=h&&(o=s+1,h=h-1,e++);return(caretPositionAmp=parseInt(caretPositionAmp),t.onmouseup=function(){document.selection&&typeof t.selectionStart!="number"&&(t.focus(),r=document.selection.createRange(),i=t.createTextRange(),f=i.duplicate(),i.moveToBookmark(r.getBookmark()),f.setEndPoint("EndToStart",i),caretPositionAmp=f.text.length)},document.selection&&typeof t.selectionStart!="number")?(r=document.selection.createRange(),r.text.length!=0)?this:(i=t.createTextRange(),textLength=i.text.length,f=i.duplicate(),i.moveToBookmark(r.getBookmark()),f.setEndPoint("EndToStart",i),u=f.text.length,caretPositionAmp>0&&u==0?(e=caretPositionAmp-e,i.move("character",e),i.select(),r=document.selection.createRange(),caretPositionAmp+=n.length):caretPositionAmp>=0||textLength!=0?caretPositionAmp>=0||u!=0?!(caretPositionAmp>=0)&&u>0?(i.move("character",0),document.selection.empty(),i.select(),r=document.selection.createRange(),caretPositionAmp=u+n.length):caretPositionAmp>=0&&caretPositionAmp==textLength?(textLength!=0?(i.move("character",textLength),i.select()):i.move("character",0),r=document.selection.createRange(),caretPositionAmp=n.length+textLength):caretPositionAmp>=0&&u!=0&&caretPositionAmp>=u?(e=caretPositionAmp-u,i.move("character",e),document.selection.empty(),i.select(),r=document.selection.createRange(),caretPositionAmp=caretPositionAmp+n.length):caretPositionAmp>=0&&u!=0&&caretPositionAmp<u?(i.move("character",0),document.selection.empty(),i.select(),r=document.selection.createRange(),caretPositionAmp=caretPositionAmp+n.length):(document.selection.empty(),i.select(),r=document.selection.createRange(),caretPositionAmp=caretPositionAmp+n.length):(i.move("character",textLength),i.select(),r=document.selection.createRange(),caretPositionAmp=n.length+textLength):(r=document.selection.createRange(),caretPositionAmp=n.length+textLength),r.text=n,t.focus(),this):typeof t.selectionStart=="number"&&t.selectionStart==t.selectionEnd?(o=t.selectionStart+n.length,u=t.selectionStart,a=t.selectionEnd,t.value=t.value.substr(0,u)+n+t.value.substr(a),t.setSelectionRange(o,o),t.scrollTop=v,this):this},setCaretPos:function(n){var t=this.jquery?this[0]:this,s,e,f,r=0,o=0,i,u;if(t.focus(),parseInt(n)==0)return this;if(parseInt(n)>0){if(n=parseInt(n)-1,document.selection&&typeof t.selectionStart=="number"&&t.selectionStart==t.selectionEnd&&(t.value.match(/\n/g)!=null&&(r=t.value.match(/\n/g).length),r>0))for(u=0;u<=r;u++)i=t.value.indexOf("\n",f),i!=-1&&i<=n&&(f=i+1,n=parseInt(n)+1)}else if(parseInt(n)<0)if(n=parseInt(n)+1,document.selection&&typeof t.selectionStart!="number"){if(n=t.value.length+parseInt(n),t.value.match(/\n/g)!=null&&(r=t.value.match(/\n/g).length),r>0){for(u=0;u<=r;u++)i=t.value.indexOf("\n",f),i!=-1&&i<=n&&(f=i+1,n=parseInt(n)-1,o+=1);n=n+o-r}}else if(document.selection&&typeof t.selectionStart=="number"){if(n=t.value.length+parseInt(n),t.value.match(/\n/g)!=null&&(r=t.value.match(/\n/g).length),r>0)for(n=parseInt(n)-r,u=0;u<=r;u++)i=t.value.indexOf("\n",f),i!=-1&&i<=n&&(f=i+1,n=parseInt(n)+1,o+=1)}else n=t.value.length+parseInt(n);else return this;return document.selection&&typeof t.selectionStart!="number"?(s=document.selection.createRange(),s.text!=0)?this:(e=t.createTextRange(),e.collapse(!0),e.moveEnd("character",n),e.moveStart("character",n),e.select(),caretPositionAmp=n,this):typeof t.selectionStart=="number"&&t.selectionStart==t.selectionEnd?(t.setSelectionRange(n,n),this):this},countCharacters:function(){var t=this.jquery?this[0]:this;return t.value.match(/\r/g)!=null?t.value.length-t.value.match(/\r/g).length:t.value.length},setMaxLength:function(n,t){return this.each(function(){var i=this.jquery?this[0]:this,u=i.type,f,r;if(parseInt(n)<0&&(n=1e8),u=="text"&&(i.maxLength=n),u=="textarea"||u=="text")i.onkeypress=function(u){var s=i.value.match(/\r/g),o,e;return r=n,s!=null&&(r=parseInt(r)+s.length),o=u||event,e=o.keyCode,f=document.selection?document.selection.createRange().text.length>0:i.selectionStart!=i.selectionEnd,i.value.length>=r&&(e>47||e==32||e==0||e==13)&&!o.ctrlKey&&!o.altKey&&!f?(i.value=i.value.substring(0,r),typeof t=="function"&&t(),!1):void 0},i.onkeyup=function(){var e=i.value.match(/\r/g),o=0,u=0,f;if(r=n,e!=null){for(f=0;f<=e.length;f++)i.value.indexOf("\n",u)<=parseInt(n)&&(o++,u=i.value.indexOf("\n",u)+1);r=parseInt(n)+o}if(i.value.length>r)return i.value=i.value.substring(0,r),typeof t=="function"&&t(),this};else return this}),this}})